---
import { Image, Picture } from 'astro:assets';
import { getCollection, getEntry, getEntries } from 'astro:content';
import { SiteMetadata } from '@/config';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { formatBlogPosts } from '@/utils';
import slugify from '@sindresorhus/slugify';
import { Sprite } from 'astro-icon';
// import Categories from '@/components/Categories.astro';
import { Breadcrumbs } from 'astro-breadcrumbs';
// const categories = await getCollection('category');
// const { category } = Astro.params;
// const detail = await getEntry('category', category!);

export async function getStaticPaths() {
	const allPosts = await getCollection('blog');
	const posts = formatBlogPosts(allPosts);
	return posts.map((post) => {
		return {
			params: {
				slug: post.data.categories.map((category) => category.id) + '/' + slugify(post.slug),
			},
			props: {
				post,
			},
		};
	});
}

const { post } = Astro.props;

const { data: authorData } = await getEntry('team', post.data.author.id);
const categories = await getEntries(post.data.categories);
const { Content } = await post.render();
---

<BaseLayout title={post.data.title + ' | ' + SiteMetadata.logo_name}>
	<main>
		<article>
			<header class="z-30 grid">
				<div class="col-span-full row-span-full">
					{
						post.data.coverImage && (
							<Picture
								src={post.data.coverImage}
								formats={['avif', 'webp']}
								widths={[600, 800, 1200]}
								sizes="100vw"
								alt={post.data.title}
								loading="eager"
								class="h-[80vh] min-h-[400px] w-full object-cover"
							/>
						)
					}
				</div>
				<div class="col-span-full row-span-full mt-auto bg-gradient-to-t from-black/80">
					<div class="container pb-[10%]">
						<div>
							{
								categories && (
									<div class="flex flex-row flex-wrap items-start gap-2 pb-2">
										{categories.map((category) => (
											<a
												href={`${import.meta.env.BASE_URL}blog/${encodeURIComponent(category.id)}/`}
												class="inline-block rounded bg-purple-600 px-2 py-1 text-sm font-bold uppercase tracking-tight text-white hover:bg-pink-600"
											>
												{category.data.title}
											</a>
										))}
									</div>
								)
							}
							<h2 class="text-4xl font-bold text-gray-800 dark:text-gray-200">{post.data.title}</h2>
							{post.data.description && <p class="text-gray-300">{post.data.description}</p>}
							<div class="flex pt-2">
								<span class="mr-6 flex items-center">
									{
										authorData.headshot && (
											<Image
												src={authorData.headshot}
												alt={authorData.name}
												class="mr-2 h-10 w-10 rounded-full object-cover"
											/>
										)
									}
									<span class="font-semibold text-purple-200">{authorData.name}</span>
								</span>
								<span class="mr-6 flex items-center text-purple-200">
									<Sprite
										name="calendar"
										size={24}
										aria-hidden="true"
										class="mr-1 fill-current"
										title="Дата публикации"
									/>
									<time
										datetime={post.data.publishDate.toISOString()}
										class="ml-1 font-semibold text-current"
									>
										{
											post.data.publishDate
												.toLocaleDateString(SiteMetadata.locale, {
													year: 'numeric',
													month: 'long',
													day: 'numeric',
													timeZone: 'UTC',
												})
												.replace(/\s*г\./, '')
										}
									</time>
								</span>
								<span class="mr-6 flex items-center text-purple-200">
									<Sprite
										name="clock"
										size={24}
										aria-hidden="true"
										class="mr-1 fill-current"
										title="Время на прочтение"
									/>
									<span class="font-semibold text-purple-200">2 мин</span>
								</span>
							</div>
							<div class="mt-2 flex flex-row flex-wrap items-start gap-4 lg:gap-2">
								<a
									href="/hello-astro/tag/roadmap/"
									class="inline-block rounded bg-pink-100 px-2 py-2 text-xs font-semibold text-purple-900 hover:bg-purple-300 hover:text-black lg:py-1"
								>
									#roadmap</a
								><a
									href="/hello-astro/tag/astro/"
									class="inline-block rounded bg-pink-100 px-2 py-2 text-xs font-semibold text-purple-900 hover:bg-purple-300 hover:text-black lg:py-1"
								>
									#astro</a
								><a
									href="/hello-astro/tag/sponsor/"
									class="inline-block rounded bg-pink-100 px-2 py-2 text-xs font-semibold text-purple-900 hover:bg-purple-300 hover:text-black lg:py-1"
								>
									#sponsor</a>
							</div>
						</div>
					</div>
				</div>
				<!-- <Breadcrumbs /> -->
			</header>
		</article>
	</main>
	<Content />
</BaseLayout>
